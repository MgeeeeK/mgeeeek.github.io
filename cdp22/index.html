<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Coding Period: Second Phase Part 2 - MgeeeeK Home</title><meta name="Description" content="Guide to emoji usage in Hugo and LoveIt."><meta property="og:title" content="Coding Period: Second Phase Part 2" />
<meta property="og:description" content="Guide to emoji usage in Hugo and LoveIt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mgeeeek.github.io/cdp22/" /><meta property="og:image" content="https://mgeeeek.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-31T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-07-31T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://mgeeeek.github.io/logo.png"/>

<meta name="twitter:title" content="Coding Period: Second Phase Part 2"/>
<meta name="twitter:description" content="Guide to emoji usage in Hugo and LoveIt."/>
<meta name="application-name" content="$ cd $HOME">
<meta name="apple-mobile-web-app-title" content="$ cd $HOME"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://mgeeeek.github.io/cdp22/" /><link rel="prev" href="https://mgeeeek.github.io/cdp21/" /><link rel="next" href="https://mgeeeek.github.io/cdp31/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Coding Period: Second Phase Part 2",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/mgeeeek.github.io\/cdp22\/"
        },"image": ["https:\/\/mgeeeek.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "pysal, CPP2P2","wordcount":  1501 ,
        "url": "https:\/\/mgeeeek.github.io\/cdp22\/","datePublished": "2020-07-31T00:00:00+00:00","dateModified": "2020-07-31T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/mgeeeek.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Mragank Shekhar"
            },"description": "Guide to emoji usage in Hugo and LoveIt."
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="MgeeeeK Home"><span class="header-title-pre"><i class='fas fa-dollar-sign fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/files/mragankshekhar_cv260521.pdf"> Resume </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="MgeeeeK Home"><span class="header-title-pre"><i class='fas fa-dollar-sign fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/files/mragankshekhar_cv260521.pdf" title="">Resume</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Coding Period: Second Phase Part 2</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/MgeeeeK" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Mragank Shekhar</a></span>&nbsp;<span class="post-category">included in <a href="/categories/gsoc20/"><i class="far fa-folder fa-fw"></i>gsoc20</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="31-07-2020">31-07-2020</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1501 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;8 minutes&nbsp;<span id="/cdp22/" class="leancloud_visitors" data-flag-title="Coding Period: Second Phase Part 2">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#final-api-of-the-interface">Final API of the Interface</a></li>
    <li><a href="#example-notebook-for-raster-awareness-api">Example Notebook for Raster awareness API</a>
      <ul>
        <li><a href="#loading-data">Loading Data</a>
          <ul>
            <li><a href="#using-local-netcdf-dataset">Using local <code>NetCDF</code> dataset</a></li>
            <li><a href="#using-local-geotiff-dataset">Using local <code>GeoTIFF</code> dataset</a></li>
          </ul>
        </li>
        <li><a href="#additional-resources">Additional resources</a></li>
      </ul>
    </li>
    <li><a href="#whats-next">What&rsquo;s next?</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><em>Phase two of GSoC2020 is over, this blog is little late cos my laptop&rsquo;s HDD died and I was unable to save my Hugo environment. Overall the summer has been really productive and the API design of the interface is finally reached beta period, let&rsquo;s look at the progress.</em></p>
<h2 id="final-api-of-the-interface">Final API of the Interface</h2>
<p>After several weeks of coding, design discussions, and code review, phase 1 of my project which consisted of designing API and all the functionality for the base raster interface is completed. In the last couple of weeks, I had to work on refactoring the methods to align them with the future design of the weights object, along with this there were some new test cases that I had to deal with as my earlier approach was focused only on <code>GDAL raster formats</code> and <code>open_rasterio</code> method which restricted the interface from being used with other datasets like <code>NetCDF</code> and therefore I&rsquo;d to work on refactoring and thinking what will be the best way to introduce this functionality in the interface.</p>
<p>These new changes were finalized after project meeting with my mentors, they explained that it&rsquo;ll be ideal if the support for other datasets is extended and the methods could be made more generalized. For this, a parameter <code>dims</code> was added to the weight builders, this argument will accept a dictionary, if dimensions of the <code>DataArray</code> does not match default dimensions which are <code>['band', 'time', 'lat', 'y', 'lon', 'x']</code>.</p>
<p>e.g. <code>dims</code> dictionary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># none of the dimension belong to the default dimension list</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span>                  
<span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">)</span>
<span class="c1"># dimension values should be properly aligned with the following keys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;layer&#34;</span><span class="p">:</span> <span class="s2">&#34;year&#34;</span><span class="p">,</span>
        <span class="s2">&#34;lat&#34;</span><span class="p">:</span> <span class="s2">&#34;height&#34;</span><span class="p">,</span>
        <span class="s2">&#34;lon&#34;</span><span class="p">:</span> <span class="s2">&#34;width&#34;</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After adding new fixes, I worked on adding documentation and tests which took me a while to get my head around. After a few iterations of code review by my mentors, they notified me that I need to follow the <code>NumPy</code> doc convention for adding docstring. And in the last week of phase 2, I was able to finalize most of the work, you can check this pr which itself documents my progress in the second phase.</p>
<ul>
<li><a href="https://github.com/pysal/libpysal/pull/318" target="_blank" rel="noopener noreffer">[WIP] : Base Raster Interface</a></li>
</ul>
<p>I&rsquo;ve provided an example notebook, which will try to cover the functionality offered by the raster interface.</p>
<h2 id="example-notebook-for-raster-awareness-api">Example Notebook for Raster awareness API</h2>
<p>This notebook will give an overview of newly developed raster interface. We&rsquo;ll cover
basic usage of the functionality offered by the interface which mainly involves:</p>
<ol>
<li>converting <code>xarray.DataArray</code> object to the PySAL&rsquo;s weights object (<code>libpysal.weights.W</code>/<code>WSP</code>).</li>
<li>going back to the <code>xarray.DataArray</code> from weights object.</li>
</ol>
<p>using different datasets:</p>
<ul>
<li>with missing values.</li>
<li>with multiple layers.</li>
<li>with non conventional dimension names.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">from</span> <span class="nn">libpysal.weights</span> <span class="kn">import</span> <span class="n">Rook</span><span class="p">,</span> <span class="n">Queen</span><span class="p">,</span> <span class="n">KNN</span>
<span class="kn">from</span> <span class="nn">libpysal.weights</span> <span class="kn">import</span> <span class="n">raster</span>
<span class="kn">import</span> <span class="nn">libpysal</span> <span class="kn">as</span> <span class="nn">lp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="kn">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">esda</span> <span class="kn">import</span> <span class="n">Moran_Local</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="loading-data">Loading Data</h3>
<p><em>The interface only accepts <code>xarray.DataArray</code></em>, this can be easily obtained from raster data
format using <code>xarray</code>&rsquo;s I/O functionality which can read from a variety of data formats some of them are listed below:</p>
<ul>
<li><a href="https://svn.osgeo.org/gdal/tags/gdal_1_2_5/frmts/formats_list.html" target="_blank" rel="noopener noreffer">GDAL Raster Formats</a> via <code>open_rasterio</code> method.</li>
<li><a href="https://www.unidata.ucar.edu/software/netcdf/" target="_blank" rel="noopener noreffer">NetCDF</a> via <code>open_dataset</code> method.</li>
</ul>
<p>In this notebook we&rsquo;ll work with <code>NetCDF</code> and <code>GeoTIFF</code> data.</p>
<h4 id="using-local-netcdf-dataset">Using local <code>NetCDF</code> dataset</h4>
<p>In this small example we&rsquo;ll build <code>KNN</code> distance weight object using a local <code>NetCDF</code> dataset with different dimensions names which doesn&rsquo;t belong to the default list of dimensions.</p>
<p>We&rsquo;ll also see how to speed up the reverse journey (from weights object to <code>DataArray</code>) by passing prebuilt <code>coords</code> and <code>attrs</code> to <code>w2da</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># After loading netCDF dataset we obtained a xarray.Dataset object</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;ECMWF_ERA-40_subset.nc&#39;</span><span class="p">)</span>
<span class="c1"># This Dataset object containes several data variables    </span>
<span class="k">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>                                         
</code></pre></td></tr></table>
</div>
</div><pre><code>&lt;xarray.Dataset&gt;
Dimensions:    (latitude: 73, longitude: 144, time: 62)
Coordinates:
  * longitude  (longitude) float32 0.0 2.5 5.0 7.5 ... 350.0 352.5 355.0 357.5
  * latitude   (latitude) float32 90.0 87.5 85.0 82.5 ... -85.0 -87.5 -90.0
  * time       (time) datetime64[ns] 2002-07-01T12:00:00 ... 2002-07-31T18:00:00
Data variables:
    tcw        (time, latitude, longitude) float32 ...
    tcwv       (time, latitude, longitude) float32 ...
    lsp        (time, latitude, longitude) float32 ...
    cp         (time, latitude, longitude) float32 ...
    msl        (time, latitude, longitude) float32 ...
    blh        (time, latitude, longitude) float32 ...
    tcc        (time, latitude, longitude) float32 ...
    p10u       (time, latitude, longitude) float32 ...
    p10v       (time, latitude, longitude) float32 ...
    p2t        (time, latitude, longitude) float32 ...
    p2d        (time, latitude, longitude) float32 ...
    e          (time, latitude, longitude) float32 ...
    lcc        (time, latitude, longitude) float32 ...
    mcc        (time, latitude, longitude) float32 ...
    hcc        (time, latitude, longitude) float32 ...
    tco3       (time, latitude, longitude) float32 ...
    tp         (time, latitude, longitude) float32 ...
Attributes:
    Conventions:  CF-1.0
    history:      2004-09-15 17:04:29 GMT by mars2netcdf-0.92
</code></pre>
<p>Out of 17 data variables we&rsquo;ll use <code>p2t</code> for our analysis. This will give us our desired <code>DataArray</code> object <code>da</code>, we will further group <code>da</code> by day, taking average over the <code>time</code> dimension.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># this will give us the required DataArray with p2t (2 metre temperature) data variable</span>
<span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&#34;p2t&#34;</span><span class="p">]</span>  
<span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>('day', 'latitude', 'longitude')
</code></pre>
<p><strong>Weight builders (<code>from_xarray</code>, <code>da2W</code>, <code>da2WSP</code>) can recognise dimensions belonging to this list <code>[band, time, lat, y, lon, x]</code>, if any of the dimension in the <code>DataArray</code> does not belong to the mentioned list then we need to pass a dictionary (specifying that dimension’s name) to the weight builder. We can see that the none of dimensions of <code>da</code> matches with the default dimensions (<code>[band, time, lat, y, lon, x]</code>)</strong></p>
<p>This means we have to create a dictionary mentioning the dimensions and ship it to weight builder, similar to our last example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dims</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dims</span><span class="p">[</span><span class="s2">&#34;lat&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;latitude&#34;</span>
<span class="n">dims</span><span class="p">[</span><span class="s2">&#34;lon&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;longitude&#34;</span>
<span class="n">dims</span><span class="p">[</span><span class="s2">&#34;layer&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;day&#34;</span>
<span class="n">w_knn</span> <span class="o">=</span> <span class="n">KNN</span><span class="o">.</span><span class="n">from_xarray</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># we can derive the data from DataArray using index attribute</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_series</span><span class="p">()[</span><span class="n">w_knn</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>  
</code></pre></td></tr></table>
</div>
</div><p>We can now speed up <code>w2da</code> by passing <code>coords</code> from the existing <code>DataArray</code> <code>da</code> which we used earlier.</p>
<p>Along with <code>coords</code> we can also pass <code>attrs</code> of the same <code>DataArray</code> this will help <code>w2da</code> to retain all the properties of original <code>DataArray</code>.</p>
<p>Let&rsquo;s compare the <code>DataArray</code> returned by <code>w2da</code> and original <code>DataArray</code>. For this we&rsquo;ll ship the derived data straight to <code>w2da</code> without any statistical analysis.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">da1</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">w2da</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">w_knn</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">da</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<span class="c1"># method to compare 2 DataArray, if true then w2da was successfull</span>
<span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">],</span> <span class="n">da1</span><span class="p">)</span>  
</code></pre></td></tr></table>
</div>
</div><pre><code>True
</code></pre>
<h4 id="using-local-geotiff-dataset">Using local <code>GeoTIFF</code> dataset</h4>
<p>Up until now we&rsquo;ve only played with <code>netCDF</code> datasets but in this example we&rsquo;ll use a <code>raster.tif</code> file to see how interface interacts with it. We&rsquo;ll also see how these methods handle missing data.</p>
<p>Unlike earlier we&rsquo;ll use weight builder methods from <code>raster.py</code>, which we can call directly. Just a reminder that <code>from_xarray</code> uses methods from <code>raster.py</code> and therefore only difference exists in the API.</p>
<p>To access GDAL Raster Formats xarray offers <code>open_rasterio</code> method which uses <code>rasterio</code> as backend. It loads metadata, coordinate values from the raster file and assign them to the <code>DataArray</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Loading raster data with missing values</span>
<span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;lux_ppp_2019.tif&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>&lt;xarray.DataArray (band: 1, y: 880, x: 940)&gt;
[827200 values with dtype=float32]
Coordinates:
  * band     (band) int64 1
  * y        (y) float64 50.18 50.18 50.18 50.18 ... 49.45 49.45 49.45 49.45
  * x        (x) float64 5.745 5.746 5.747 5.747 ... 6.525 6.526 6.527 6.527
Attributes:
    transform:      (0.0008333333297872345, 0.0, 5.744583325, 0.0, -0.0008333...
    crs:            +init=epsg:4326
    res:            (0.0008333333297872345, 0.0008333333295454553)
    is_tiled:       0
    nodatavals:     (-99999.0,)
    scales:         (1.0,)
    offsets:        (0.0,)
    AREA_OR_POINT:  Area
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># we can see that the DataArray contains missing values.</span>
<span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">&gt;</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&#34;nodatavals&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> 
</code></pre></td></tr></table>
</div>
</div><pre><code>&lt;matplotlib.collections.QuadMesh at 0x7f27287a3550&gt;
</code></pre>
<a class="lightgallery" href="/images/Raster_awareness_API_29_1.png" title="png" data-thumbnail="/images/Raster_awareness_API_29_1.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/Raster_awareness_API_29_1.png"
            data-srcset="/images/Raster_awareness_API_29_1.png, /images/Raster_awareness_API_29_1.png 1.5x, /images/Raster_awareness_API_29_1.png 2x"
            data-sizes="auto"
            alt="png" />
    </a>
<p>We&rsquo;ll look at how weight builders handle missing values. Firstly we&rsquo;ll slice the <code>DataArray</code> to reduce overall size for easier visualization.</p>
<p>This time we&rsquo;ll create <code>WSP</code> object using <code>da2WSP</code> method inside <code>raster.py</code>. Since our DataArray is single banded and all of its dimensions belong to the default list, we&rsquo;ve to only ship the DataArray to the <code>da2WSP</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Slicing the dataarray</span>
<span class="n">da_s</span> <span class="o">=</span> <span class="n">da</span><span class="p">[:,</span> <span class="mi">330</span><span class="p">:</span><span class="mi">340</span><span class="p">,</span> <span class="mi">129</span><span class="p">:</span><span class="mi">139</span><span class="p">]</span>
<span class="n">w_queen</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">da2WSP</span><span class="p">(</span><span class="n">da_s</span><span class="p">)</span>  <span class="c1"># default contiguity is queen</span>
<span class="n">w_rook</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">da2WSP</span><span class="p">(</span><span class="n">da_s</span><span class="p">,</span> <span class="s2">&#34;rook&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>After plotting both contiguities and sliced <code>DataArray</code>, we can see that the missing values are ignored by the <code>da2WSP</code> method and only indices of non missing values are stored in <code>index</code> attribute of <code>WSP</code> object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">f</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">))</span>
<span class="n">da_s</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_s</span><span class="o">.</span><span class="n">values</span><span class="o">&gt;</span><span class="n">da_s</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&#34;nodatavals&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Sliced raster&#34;</span><span class="p">)</span>
<span class="n">plot_spatial_weights</span><span class="p">(</span><span class="n">w_rook</span><span class="p">,</span> <span class="n">da_s</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Rook contiguity&#34;</span><span class="p">)</span>
<span class="n">plot_spatial_weights</span><span class="p">(</span><span class="n">w_queen</span><span class="p">,</span> <span class="n">da_s</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Queen contiguity&#34;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><a class="lightgallery" href="/images/Raster_awareness_API_33_0.png" title="png" data-thumbnail="/images/Raster_awareness_API_33_0.png">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/Raster_awareness_API_33_0.png"
            data-srcset="/images/Raster_awareness_API_33_0.png, /images/Raster_awareness_API_33_0.png 1.5x, /images/Raster_awareness_API_33_0.png 2x"
            data-sizes="auto"
            alt="png" />
    </a>
<h3 id="additional-resources">Additional resources</h3>
<ol>
<li><a href="http://xarray.pydata.org/en/stable/io.html" target="_blank" rel="noopener noreffer">Reading and writing files using Xarray</a></li>
<li><a href="http://xarray.pydata.org/en/stable/data-structures.html" target="_blank" rel="noopener noreffer">Xarray Data Structures</a></li>
</ol>
<h2 id="whats-next">What&rsquo;s next?</h2>
<p>My first deliverable is almost complete (few bugs here and there stills exists and beta testing is still going on). This coding phase is dedicated towards optimizing and integration of raster interface. Regarding optimization, I&rsquo;ve succesfully built a faster raster weight builder using <code>numba</code> and <code>COO_matrix</code>, I&rsquo;m working on the multicore implementation for the same. After finishing high performant weight builder, I&rsquo;ll look into efficiently increasing the neighbors in the weights object.</p>
<p>Find out what happens next in the episode of GSoC2020&hellip; until then bye-bye 👋.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 31-07-2020</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/cdp22/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/pysal/">pysal</a>,&nbsp;<a href="/tags/cpp2p2/">CPP2P2</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/cdp21/" class="prev" rel="prev" title="Coding Period: Second Phase Part 1"><i class="fas fa-angle-left fa-fw"></i>Coding Period: Second Phase Part 1</a>
            <a href="/cdp31/" class="next" rel="next" title="Coding Period: Last Phase Part 1">Coding Period: Last Phase Part 1<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
    <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer"
                title="Hugo 0.83.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank"
                rel="noopener noreffer" title="LoveIt 0.2.10"><i class="fab fa-github"></i></a>
        </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a
                    href="https://github.com/MgeeeeK" target="_blank">Mragank Shekhar</a></span></div>
    </div>
</footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"valine":{"appId":"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI","appKey":"WBmoGyJtbqUswvfLh6L8iEBr","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://leancloud.hugoloveit.com","visitor":true}},"data":{"id-1":"cd $HOME","id-2":"cd $HOME"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
